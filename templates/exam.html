<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MCQ Exam</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .question-card {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
    </style>
</head>

<body class="bg-light">

<div class="container mt-4">
    <h3 class="text-center mb-4">MCQ Examination</h3>

    <!-- Webcam -->
    <div class="text-center mb-3">
        <video id="webcam" width="240" autoplay muted
               style="border:2px solid #333; border-radius:8px;"></video>
    </div>

    <!-- Start Button -->
    <div class="text-center mb-3">
        <button id="startBtn" class="btn btn-primary" onclick="startExam()">
            Start Exam
        </button>
    </div>

    <!-- EXAM FORM -->
    <form id="examForm" method="POST" action="/submit_exam">

        {% for q in questions %}
        <div class="question-card">
            <p><strong>{{ loop.index }}. {{ q.question }}</strong></p>

            {% for opt in q.options %}
            <div class="form-check">
                <input class="form-check-input"
                       type="radio"
                       name="{{ q.id }}"
                       value="{{ opt }}"
                       disabled
                       required>
                <label class="form-check-label">
                    {{ opt }}
                </label>
            </div>
            {% endfor %}
        </div>
        {% endfor %}

        <div class="text-center">
            <button type="submit" class="btn btn-success mt-3" disabled id="submitBtn">
                Submit Exam
            </button>
        </div>

    </form>
</div>

<script>
/* ================== CONFIG ================== */
const studentId = "student_001";

/* ================== TAB SWITCH ================== */
let tabSwitchCount = 0;
const MAX_TAB_SWITCH = 3;

document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
        tabSwitchCount++;

        alert("⚠️ Warning: Tab switching is not allowed!\nAttempt: " + tabSwitchCount);

        fetch("/log_violation", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                student_id: studentId,
                reason: "Tab switched " + tabSwitchCount
            })
        });

        if (tabSwitchCount >= MAX_TAB_SWITCH) {
            alert("❌ Too many tab switches. Exam will be submitted.");
            document.getElementById("examForm").submit();
        }
    }
});

/* ================== CAMERA ================== */
let cameraStream;

async function startCamera() {
    cameraStream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: false
    });
    document.getElementById("webcam").srcObject = cameraStream;
}

/* ================== FACE NOT DETECTED ================== */
let faceMissCount = 0;
const MAX_FACE_MISS = 3;

setInterval(() => {
    const video = document.getElementById("webcam");

    if (!video.srcObject || video.videoWidth === 0) {
        faceMissCount++;

        alert("⚠️ Face not detected!\nWarning: " + faceMissCount);

        fetch("/log_violation", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                student_id: studentId,
                reason: "Face not detected"
            })
        });

        if (faceMissCount >= MAX_FACE_MISS) {
            alert("❌ Face not detected multiple times. Exam submitted.");
            document.getElementById("examForm").submit();
        }
    }
}, 7000);

/* ================== START EXAM ================== */
async function startExam() {
    try {
        await startCamera();

        alert("✅ Exam started. Monitoring enabled.");

        document
            .querySelectorAll("input[type=radio]")
            .forEach(i => i.disabled = false);

        document.getElementById("submitBtn").disabled = false;
        document.getElementById("startBtn").disabled = true;

    } catch (err) {
        alert("❌ Camera permission is mandatory to start the exam.");
    }
}

/* ================== REFRESH WARNING ================== */
window.onbeforeunload = () => "Leaving will submit your exam!";
</script>

</body>
</html>
