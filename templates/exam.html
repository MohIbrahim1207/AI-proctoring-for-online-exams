<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MCQ Exam</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <style>
        .question-card {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
    </style>
</head>

<body class="bg-light">

<div class="container mt-4">

    <h3 class="text-center mb-4">MCQ Examination</h3>

    <!-- Webcam Preview -->
    <div class="text-center mb-3">
        <video id="webcam" width="240" autoplay muted
               style="border:2px solid #333; border-radius:8px;">
        </video>
    </div>

    <!-- Start Exam Button -->
    <div class="text-center mb-3">
        <button id="startBtn" class="btn btn-primary" onclick="startExam()">
            Start Exam
        </button>
    </div>

    <!-- Timer -->
    <div class="text-center mb-3">
        <span class="badge bg-warning text-dark" id="timer">
            Time Left: 30:00
        </span>
    </div>

    <form id="examForm" method="POST" action="/submit_exam">

        {% for q in questions %}
        <div class="question-card">
            <p><strong>{{ loop.index }}. {{ q.question }}</strong></p>

            {% for opt in q.options %}
            <div class="form-check">
                <input class="form-check-input"
                       type="radio"
                       name="{{ q.id }}"
                       value="{{ opt }}"
                       disabled>
                <label class="form-check-label">
                    {{ opt }}
                </label>
            </div>
            {% endfor %}
        </div>
        {% endfor %}

        <div class="text-center">
            <button type="submit" class="btn btn-success mt-3" disabled id="submitBtn">
                Submit Exam
            </button>
        </div>

    </form>

</div>

<!-- ================= SCRIPTS ================= -->

<script>
const studentId = "student_001";
let tabSwitchCount = 0;
const MAX_TAB_SWITCH = 3;

let cameraStream;
let screenStream;
let screenInterval;

// -------- START CAMERA --------
async function startCamera() {
    cameraStream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: false
    });
    document.getElementById("webcam").srcObject = cameraStream;
}

// -------- START SCREEN + CAMERA --------
async function startExam() {
    try {
        // Start camera
        await startCamera();

        // Start screen sharing
        screenStream = await navigator.mediaDevices.getDisplayMedia({
            video: { frameRate: 1 }
        });

        alert("✅ Camera & Screen monitoring started. Exam unlocked.");
        enableExam();

        const video = document.createElement("video");
        video.srcObject = screenStream;
        video.play();

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        screenInterval = setInterval(() => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append("student_id", studentId);
                formData.append("file", blob, "screen.jpg");

                fetch("/proctor/upload_screen", {
                    method: "POST",
                    body: formData
                });
            }, "image/jpeg", 0.6);

        }, 5000);

        // If screen sharing stops
        screenStream.getVideoTracks()[0].onended = () => {
            alert("❌ Screen sharing stopped! Exam submitted.");
            clearInterval(screenInterval);
            document.getElementById("examForm").submit();
        };

    } catch (err) {
        alert("❌ Camera & screen permission is mandatory.");
    }
}

// -------- ENABLE EXAM --------
function enableExam() {
    document.querySelectorAll("input").forEach(i => i.disabled = false);
    document.getElementById("submitBtn").disabled = false;
    document.getElementById("startBtn").disabled = true;
}

// -------- TAB SWITCH DETECTION --------
document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
        tabSwitchCount++;

        fetch("/log_violation", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                student_id: studentId,
                reason: "Tab switch " + tabSwitchCount
            })
        });

        if (tabSwitchCount >= MAX_TAB_SWITCH) {
            alert("❌ Too many violations. Exam submitted.");
            document.getElementById("examForm").submit();
        }
    }
});

// -------- REFRESH WARNING --------
window.onbeforeunload = () => "Leaving will submit your exam!";
</script>

</body>
</html>
